<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Connections</title>
    <link rel="stylesheet" href="styles/universal.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,400,0,0" />  
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>
</head>
  
    <body >
   

    <div class="flex fixed top-5  bg-primary rounded-full p-1">
        <div class=" rounded-full px-4 py-2 select-none" id="connections-tab"><a href="/connections" class="font-normal"><span id="chat-tab">Connections</span></a></div>
        <div class="bg-background rounded-full px-4 py-2">Chat</div>
    </div>

    <div style="display: flex; width: 100vw; height: 100vh; flex-direction: column;">
        <div style="height: 20%; width: 100%">
            
        </div>
        
    
        <div style="width: 100%; height: 80%; display: flex">
            <div style="flex: 1; padding: 20px;">
                <div style="background-color: var(--primary); width: 100%; height: 70%; border-radius: 10px;display: flex; flex-direction: column; padding:30px; overflow: auto;">
                    <div data-email="hello" class="selected friend-box" id="friend-selected-template" style="display: none; align-items: center; padding: 7px; border-radius: 20px; margin-bottom: 7px">
                        <img src="https://firebasestorage.googleapis.com/v0/b/sermo-74f7f.appspot.com/o/Person1.jpeg?alt=media&token=529b785d-11a6-4baa-b55b-71f4a7902d57" width="30" height="30" style="margin-right: 10px; border-radius: 50%;"/>
                        <p style="width: fit-content;font-size: 1.5rem; font-weight: bold;"  class="friend-select-name">Name</p>
                    </div>
                    <div data-email="hello" class="unselected friend-box" id="friend-unselected-template" style="display: none; align-items: center; padding: 7px; border-radius: 20px;margin-bottom: 7px">
                        <img src="https://firebasestorage.googleapis.com/v0/b/sermo-74f7f.appspot.com/o/Person1.jpeg?alt=media&token=529b785d-11a6-4baa-b55b-71f4a7902d57" width="30" height="30" style="margin-right: 10px; border-radius: 50%;"/>
                        <p style="width: fit-content;font-size: 1.5rem; font-weight: bold;"  class="friend-select-name">Name</p>
                    </div>
                  
                </div>
            </div>
            <div style="flex: 2;">
                <div style="margin: 20px; background-color: var(--primary); height: 90%; border-radius: 10px; display: flex; flex-direction: column;">
                    <div style="flex: 1; overflow-y: auto;">

                        <div style="padding: 20px 20px 5px 20px; display: none; min-height: 50px;" id="message-box-template">
                            <div>
                                <img style="border-radius: 50%;" src="https://firebasestorage.googleapis.com/v0/b/sermo-74f7f.appspot.com/o/Person1.jpeg?alt=media&token=529b785d-11a6-4baa-b55b-71f4a7902d57" width="30" height="30"/>
                            </div>
                            <div style="display: flex; flex-direction: column; padding-left: 10px; padding-right: 10px;">
                                <p style="font-size: 1.5rem;"><b class="message-box-name">Name</b></p>
                                <p style="font-size: 1.25rem;" class="message-box-text">My name is Lucy.My name is Lucy.My name is Lucy.My name is Lucy.My name is Lucy.My name is Lucy.My name is Lucy.My name is Lucy.My name is Lucy.My name is Lucy.My name is Lucy.My name is Lucy.My name is Lucy.My name is Lucy.</p>
                            </div>
                        </div>
                      
                       
                        
                       
                    </div>
                    <div style="height: 50px; display: flex; justify-content: center;">
                        <input style="width: 95%; margin: 10px" id="input-box" placeholder="Type message..."/>
                      
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        import { initChat } from "./scripts/chat.js";

        import { returnUser } from "./scripts/fire.js";

        async function populateFriends() {
            let selected = document.querySelector("#friend-selected-template");
            let unselected = document.querySelector("#friend-unselected-template");
            const parent = selected.parentElement;
            selected = selected.cloneNode(true);
            unselected = unselected.cloneNode(true);

            selected.style.display = "flex";
            unselected.style.display = "flex";
            selected.id = "friend-selected";
            unselected.id = "";

            const [_, {friends}] = await returnUser(Cookies.get("email"));
            for (const [idx, friend] of friends.entries()) {
                let node;
                if (idx == 0) {
                    node = selected.cloneNode(true);
                } else {
                    node = unselected.cloneNode(true);
                }
                const [email, {name, picture}] = await returnUser(friend.email);
                node.querySelector("img").src = picture;
                node.querySelector(".friend-select-name").innerText = name;
                node.dataset.email = email;
                parent.appendChild(node);
            }
        }


        function appendMessage(item) {
            let node = document.querySelector("#message-box-template");
            const parent = node.parentElement;

            const sender = item.sender;
            const message = item.message;
            const picture = item.picture;
            node = node.cloneNode(true);
            
            node.querySelector("img").src = picture;
            node.querySelector(".message-box-name").innerText = sender;
            node.querySelector(".message-box-text").innerText = message;
            node.id = "";
            node.style.display = "flex";
            parent.appendChild(node);
        }

        function clearMessages() {
            let node = document.querySelector("#message-box-template");
            const parent = node.parentElement;
            // clear parent's children
            
            parent.innerHTML = "";


           parent.appendChild(node);
        }

        // note that loadMessages clears the message list
        // messages: [{sender: string, message: string, picture: url string}]
        function loadMessages(messages) {
            let node = document.querySelector("#message-box-template");
            const parent = node.parentElement;
            
            clearMessages();
            


            for (const item of messages) {
                appendMessage(item);
            }
        }
    

        async function attachFriendClickListener() {
            const friendBoxes = document.querySelectorAll(".friend-box");
            for (const friendBox of friendBoxes) {
                friendBox.addEventListener("click", async function() {
                    const ownEmail = Cookies.get("email");
                    const corEmail = this.dataset.email;
                    clearMessages();
                    if (corEmail == "sophia.jameson@outlook.com") {
                        loadMessages([
                        {
                            sender: "Sophia",
                            message: "Hey Amelia! How have you been?",
                            picture: "assets/profiles/Person6.jpeg"
                        },
                        {
                            sender: "Amelia",
                            message: "Hi Sophia! I’m doing well, thanks. Just catching up on some work. How about you?",
                            picture: "assets/profiles/Person1.jpeg"
                        },
                        {
                            sender: "Sophia",
                            message: "I’m good, just finished a big project at work. I’m looking forward to the weekend. Got any plans?",
                            picture: "assets/profiles/Person6.jpeg"
                        },
                        {
                            sender: "Amelia",
                            message: "That sounds exciting! I’m planning to visit a new café in town and maybe go for a walk in the park. What about you?",
                            picture: "assets/profiles/Person1.jpeg"
                        },
                        {
                            sender: "Sophia",
                            message: "That sounds lovely! I’m thinking of having a movie marathon at home and maybe bake some cookies. Simple but cozy!",
                            picture: "assets/profiles/Person6.jpeg"
                        },
                        {
                            sender: "Amelia",
                            message: "Nice! Any movie recommendations? I’m always looking for something new to watch.",
                            picture: "assets/profiles/Person1.jpeg"
                        },
                        {
                            sender: "Sophia",
                            message: "Sure! If you haven't seen it yet, 'The Grand Budapest Hotel' is fantastic. It’s quirky and visually stunning.",
                            picture: "assets/profiles/Person6.jpeg"
                        },
                        {
                            sender: "Amelia",
                            message: "I’ve heard good things about that one! I’ll definitely check it out. Thanks for the tip!",
                            picture: "assets/profiles/Person1.jpeg"
                        },
                        {
                            sender: "Sophia",
                            message: "You’re welcome! Let me know what you think. Have a great weekend!",
                            picture: "assets/profiles/Person6.jpeg"
                        },
                        {
                            sender: "Amelia",
                            message: "Will do! Enjoy your movie marathon and cookies. Talk to you soon!",
                            picture: "assets/profiles/Person1.jpeg"
                        }
                        ])
                    }

                    const selected = document.querySelector("#friend-selected");
                    selected.classList.remove("selected");
                    selected.classList.add("unselected");
                    selected.id = "";

                    this.classList.remove("unselected");
                    this.classList.add("selected");
                    this.id = "friend-selected";

                })
            }
        }

        function attachInputEnterListener() {
            document.querySelector("#input-box").addEventListener("keypress", async function (e)  {
                if (e.key == "Enter") {
                    // to do: send the message

                    const user = await returnUser(Cookies.get("email"));
                    const [_, { name, picture }] = user;
                    appendMessage({sender: name, picture: picture, message: this.value});
                    this.value = "";
                    
                }
            })
        }

        (async () => {
            await populateFriends();
            await attachFriendClickListener();
            await attachInputEnterListener();

            loadMessages([
            {
                sender: "Olivia",
                message: "Hey Amelia! How's it going?",
                picture: "assets/profiles/Person2.jpeg"
            },
            {
                sender: "Amelia",
                message: "Hi Olivia! I’m doing well, thanks. Just got back from a weekend trip. How about you?",
                picture: "assets/profiles/Person1.jpeg"
            },
            {
                sender: "Olivia",
                message: "That sounds amazing! I’ve been pretty busy with work lately. Where did you go?",
                picture: "assets/profiles/Person2.jpeg"
            },
            {
                sender: "Amelia",
                message: "I went to the mountains for some hiking and relaxation. It was so refreshing. I’ve missed nature! Do you have any plans for the weekend?",
                picture: "assets/profiles/Person1.jpeg"
            },
            {
                sender: "Olivia",
                message: "That sounds lovely. I’m actually thinking of having a low-key weekend, maybe catch up on some reading. Any book recommendations?",
                picture: "assets/profiles/Person2.jpeg"
            },
            {
                sender: "Amelia",
                message: "Definitely! I recently read 'The Night Circus' by Erin Morgenstern. It’s magical and captivating. I think you’d enjoy it.",
                picture: "assets/profiles/Person1.jpeg"
            },
            {
                sender: "Olivia",
                message: "I’ve heard great things about that one! I’ll add it to my list. Thanks for the suggestion!",
                picture: "assets/profiles/Person2.jpeg"
            },
            {
                sender: "Amelia",
                message: "You’re welcome! Let me know what you think once you’ve read it. 😊",
                picture: "assets/profiles/Person1.jpeg"
            },
            {
                sender: "Olivia",
                message: "Will do! Have a great day, Amelia.",
                picture: "assets/profiles/Person2.jpeg"
            },
            {
                sender: "Amelia",
                message: "You too, Olivia. Talk soon!",
                picture: "assets/profiles/Person1.jpeg"
            }
            ])
        })();
    </script>
  </body>
</html>
